<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuración de Alertas</title>
  <link rel="stylesheet" href="../dashboard.css">
  <link rel="stylesheet" href="configalertas.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
</head>
<body>
  <div id="layout-header"></div>
  <div class="layout">
    <div id="layout-sidebar"></div>
    <main id="main-content" class="main-content config-alertas-root">
      <header class="header-section">
          <h1 class="header-section-title">Configuración de alertas</h1>
          <a href="../configalertas/docs.html" target="_blank" class="btn-ayuda-simple" title="Ver guía de Configuración de Alertas">
              <i class="ti ti-help-circle"></i> Documentación
          </a>
      </header>
      <div id="alertaGlobalMsg" class="alerta-global-msg hidden"></div>
      <div id="modalConfirmacion" class="modal-overlay hidden">
          <div class="modal-dialog modal-sm modal-confirmacion">
              <div id="modalConfirmacionMsg"></div>
              <div class="modal-actions">
                  <button id="btnModalCancelar" type="button" class="btn btn-secondary">Cancelar</button>
                  <button id="btnModalConfirmar" type="button" class="btn btn-danger">Eliminar</button>
              </div>
          </div>
      </div>
      <section class="toolbar-section">
          <button id="btnAnadirNuevaRegla" class="btn btn-primary">
              <i class="ti ti-plus"></i> Añadir nueva regla
          </button>
          <button id="btnRefrescarConfig" class="btn btn-secondary">
              <i class="ti ti-refresh"></i> Refrescar
          </button>
      </section>
      <div id="lista-reglas-container">
          <section id="reglas-activas-section" class="section-container">
              <h2 class="section-title">Reglas activas</h2>
              <div id="lista-reglas-activas-content" class="reglas-list"></div>
              <p id="no-reglas-activas" class="status-message hidden">No hay reglas activas definidas.</p>
              <p id="errorReglasActivas" class="status-message error-message hidden"></p>
          </section>
          <section id="reglas-inactivas-section" class="section-container">
              <h2 class="section-title">Reglas inactivas</h2>
              <div id="lista-reglas-inactivas-content" class="reglas-list"></div>
              <p id="no-reglas-inactivas" class="status-message hidden">No hay reglas inactivas definidas.</p>
              <p id="errorReglasInactivas" class="status-message error-message hidden"></p>
          </section>
      </div>
      <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingOverlayText">Cargando... <span id="loadingOverlayTimer"></span></div>
      </div>
      <div id="reglaModal" class="modal-overlay hidden">
        <div class="modal-dialog">
            <header class="modal-header">
                <h3 id="modalReglaTitulo">Añadir/editar regla</h3>
                <button id="modalReglaCerrarBtn" class="modal-close-button" aria-label="Cerrar"><i class="ti ti-x"></i></button>
            </header>
            <section class="modal-body">
                <form id="formRegla" novalidate>
                    <input type="hidden" id="ruleRowNumber">
                    <input type="hidden" id="ruleOriginalIndex">
                    <div class="form-group">
                        <label for="ruleNotas">Descripción (propósito de la regla):</label>
                        <textarea id="ruleNotas" rows="3" placeholder="Ej: Alerta para fallos de sincronización de stock" required></textarea>
                        <small class="help-text">Este campo es obligatorio y se mostrará como título de la regla.</small>
                    </div>
                    <div class="form-group">
                        <label for="ruleAsunto">Asunto del Email (o parte de él):</label>
                        <input type="text" id="ruleAsunto" required placeholder="Ej: Error en el pedido">
                    </div>
                    <div class="form-group">
                        <label for="ruleTipoCondicion">Tipo de Condición:</label>
                        <div class="input-with-button">
                            <select id="ruleTipoCondicion">
                                <option value="SiemprePositivo">Siempre Positivo (si asunto coincide)</option>
                                <option value="PalabraClaveEnCuerpo">Palabra Clave en Cuerpo</option>
                                <option value="ExcluirSKU">Excluir SKU (precios/SKUs)</option>
                                <option value="MultiCondicional">Multi-Condicional (Avanzado)</option>
                            </select>
                            <button type="button" id="btnInfoTipoCondicion" class="btn-info" title="Ayuda sobre Tipos de Condición"><i class="ti ti-info-circle"></i></button>
                        </div>
                    </div>
                    <div id="valorCondicionContainer" class="form-group hidden">
                        <div id="valorCondicionInputArea">
                            <input type="text" id="ruleValorCondicionSimple" placeholder="Valor o palabras separadas por coma" class="hidden">
                            <div id="multiCondicionalInputs" class="hidden">
                                <div class="multi-cond-section">
                                    <label for="multiActivarInput">Palabras/frases para ACTIVAR alerta:</label>
                                    <div class="keyword-input-group">
                                        <input type="text" id="multiActivarInput" placeholder="Añadir palabra activadora">
                                        <button type="button" id="btnAddActivarKeyword" class="btn btn-small btn-add-keyword"><i class="ti ti-plus"></i> Añadir</button>
                                    </div>
                                    <div id="activarKeywordsList" class="keywords-tag-list"></div>
                                </div>
                                <hr class="subtle-divider">
                                <div class="multi-cond-section">
                                    <label for="multiExcluirInput">Palabras/frases para EXCLUIR alerta:</label>
                                    <div class="keyword-input-group">
                                        <input type="text" id="multiExcluirInput" placeholder="Añadir palabra excluyente">
                                        <button type="button" id="btnAddExcluirKeyword" class="btn btn-small btn-add-keyword"><i class="ti ti-plus"></i> Añadir</button>
                                    </div>
                                    <div id="excluirKeywordsList" class="keywords-tag-list"></div>
                                </div>
                            </div>
                        </div>
                        <small id="valorCondicionHelpText" class="help-text"></small>
                    </div>
                    <div class="form-group">
                        <label for="ruleActiva">Estado de la Regla:</label>
                        <select id="ruleActiva">
                            <option value="Sí">Activa</option>
                            <option value="No">Inactiva</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" id="btnCancelarRegla" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" id="btnGuardarRegla" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </section>
        </div>
      </div>
      <div id="infoTipoCondicionModal" class="modal-overlay hidden">
        <div class="modal-dialog modal-sm">
            <header class="modal-header">
                <h3>Ayuda: Tipos de Condición</h3>
                <button id="modalInfoCerrarBtn" class="modal-close-button" aria-label="Cerrar"><i class="ti ti-x"></i></button>
            </header>
            <section class="modal-body-content">
                <p><strong>SiemprePositivo:</strong> La alerta siempre se marca como "Positivo" si el asunto del email coincide.</p>
                <p><strong>PalabraClaveEnCuerpo:</strong> Se marca "Positivo" si alguna de las palabras clave (separadas por coma) se encuentra en el cuerpo del email.</p>
                <p><strong>ExcluirSKU:</strong> Se marca "Positivo" si se encuentran SKUs en el email y AL MENOS UNO de ellos NO está en la lista de "Valor de Condición".</p>
                <p><strong>MultiCondicional:</strong> Lógica avanzada con listas de palabras para "Activar" y "Excluir".</p>
            </section>
        </div>
      </div>
    </main>
  </div>
  <script type="module">
    import { loadLayout } from '../shared/layout.js';
    loadLayout();
  </script>
  <script type="module" src="configalertas.js"></script>
</body>
</html>
