<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de fraudes</title>
  <link rel="stylesheet" href="../../src/assets/css/style.css">
  <link rel="stylesheet" href="form-fraudes.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
</head>
<body>
  <div id="layout-header"></div>
  <div class="layout">
    <div id="layout-sidebar"></div>
    <main id="main-content" class="main-content fraude-main-root">
      <div class="fraude-flex-root">
        <!-- COLUMNA PRINCIPAL (izquierda) -->
        <section class="fraude-col principal">
          <section class="fraude-container">
            <header class="fraude-header">
              <h2>Registro de fraudes</h2>
              <a href="https://docs.google.com/spreadsheets/d/12mgWvEzfvBi6eYqDmY_Jmpdb00lp4r1FWvERuVhM7gY/edit?usp=sharing" target="_blank" class="btn-secundario">Ver tabla</a>
            </header>
            <form id="fraude-form" autocomplete="off">
              <div class="form-grid grid-2col">
                <div class="campo" id="campo-no-logueado" style="grid-column: 1 / span 2; display: flex; align-items: center; gap:1.6rem;">
                  <input type="checkbox" id="no_logueado" name="no_logueado" />
                  <label for="no_logueado">No logueado?</label>
                </div>
                <div class="campo" id="campo-documento">
                  <label for="documento">Documento</label>
                  <input type="text" id="documento" name="documento" required />
                </div>
                <div class="campo">
                  <label for="correo">Correo</label>
                  <input type="email" id="correo" name="correo" required />
                </div>
                <div class="campo">
                  <label for="nombre">Nombre</label>
                  <input type="text" id="nombre" name="nombre" required />
                </div>
                <div class="campo">
                  <label for="comentarios">Comentarios (opcional)</label>
                  <textarea id="comentarios" name="comentarios"></textarea>
                </div>
                <div class="campo campo-full" style="grid-column: 1 / span 2;">
                  <button type="submit" class="btn-primario">
                    <span class="btn-text">Enviar</span>
                    <span class="btn-spinner" style="display:none;"><span class="loader"></span></span>
                  </button>
                </div>
              </div>
              <div class="mensaje" id="mensaje">✅ ¡Reporte enviado con éxito!</div>
              <iframe name="hidden_iframe" style="display: none;"></iframe>
            </form>

            <!-- Buscador y mini-cards (estructura base, sin lógica JS) -->
            <section class="fraude-buscador">
              <h3>Buscar en gestión de fraude</h3>
              <input type="text" id="buscadorFraude" placeholder="Buscar por documento, nombre, etc...">
            </section>
            <section class="fraude-mini-cards">
              <div class="mini-cards-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.7rem;">
                <h3 style="margin:0;">Personas agregadas</h3>
                <select id="ordenarMiniCards" style="max-width:22rem;">
                  <option value="fecha-desc">Fecha (más reciente primero)</option>
                  <option value="fecha-asc">Fecha (más antiguo primero)</option>
                  <option value="az">Nombre A-Z</option>
                  <option value="za">Nombre Z-A</option>
                </select>
              </div>
              <div id="miniCardsContainer"></div>
            </section>
          </section>
        </section>
        <!-- COLUMNA LATERAL (derecha) -->
        <aside class="fraude-col lateral">
          <section id="bloqueados-estadisticas-container" class="section-container">
            <h3 class="section-title">Resumen de bloqueados</h3>
            <div id="bloqueados-resumen-cards" class="bloqueados-resumen-cards"></div>
            <div id="bloqueados-por-mes" class="bloqueados-por-mes"></div>
          </section>
        </aside>
      </div>
    </main>
  </div>
  <script type="module">
    import { loadLayout } from '../shared/layout.js';
    loadLayout();
    // Lógica para mostrar/ocultar y autocompletar campo documento según no logueado
    const noLogueadoChk = document.getElementById('no_logueado');
    const campoDocumento = document.getElementById('campo-documento');
    const documentoInput = document.getElementById('documento');
    if (noLogueadoChk && campoDocumento && documentoInput) {
      noLogueadoChk.addEventListener('change', () => {
        if (noLogueadoChk.checked) {
          documentoInput.value = 'No logueado';
          documentoInput.readOnly = true;
          documentoInput.removeAttribute('required');
        } else {
          documentoInput.value = '';
          documentoInput.readOnly = false;
          documentoInput.setAttribute('required', 'required');
        }
      });
      // Inicializar estado
      if (noLogueadoChk.checked) {
        documentoInput.value = 'No logueado';
        documentoInput.readOnly = true;
        documentoInput.removeAttribute('required');
      } else {
        documentoInput.setAttribute('required', 'required');
      }
    }
    // Validación personalizada y envío por fetch al API Gateway
    const fraudeForm = document.getElementById('fraude-form');
    const mensaje = document.getElementById('mensaje');
    const correoInput = document.getElementById('correo');
    if (fraudeForm && mensaje && noLogueadoChk && documentoInput && correoInput) {
      fraudeForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        let valido = true;
        if (noLogueadoChk.checked) {
          if (!correoInput.value) {
            valido = false;
            correoInput.focus();
            mensaje.textContent = 'El correo es obligatorio para no logueados.';
            mensaje.style.display = 'block';
          }
        } else {
          if (!documentoInput.value) {
            valido = false;
            documentoInput.focus();
            mensaje.textContent = 'El documento es obligatorio.';
            mensaje.style.display = 'block';
          } else if (!correoInput.value) {
            valido = false;
            correoInput.focus();
            mensaje.textContent = 'El correo es obligatorio.';
            mensaje.style.display = 'block';
          }
        }
        if (!valido) {
          return false;
        }
        mensaje.style.display = 'none';
        // Mostrar spinner si tienes uno
        const btn = fraudeForm.querySelector('.btn-primario');
        const btnText = btn.querySelector('.btn-text');
        const btnSpinner = btn.querySelector('.btn-spinner');
        btn.disabled = true;
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline-flex';
        // Enviar datos al API Gateway
        try {
          const body = {
            module: 'fraudes',
            action: 'add',
            documento: documentoInput.value,
            correo: correoInput.value,
            nombre: document.getElementById('nombre').value,
            comentarios: document.getElementById('comentarios').value,
            logueado: noLogueadoChk.checked ? 'No' : 'Sí'
          };
          const response = await fetch('/api/gateway', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const result = await response.json();
          if (result.success) {
            mensaje.textContent = '✅ ¡Reporte enviado con éxito!';
            mensaje.style.display = 'block';
            setTimeout(() => window.location.reload(), 900);
          } else {
            mensaje.textContent = result.message || 'Error al enviar el reporte.';
            mensaje.style.display = 'block';
          }
        } catch (err) {
          mensaje.textContent = 'Error de red o servidor.';
          mensaje.style.display = 'block';
        } finally {
          btn.disabled = false;
          btnText.style.display = 'inline';
          btnSpinner.style.display = 'none';
        }
      });
    }
  </script>
  <script type="module" src="./form-fraudes.js"></script>
</body>
</html>
